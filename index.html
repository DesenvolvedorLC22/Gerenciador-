<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Estudos Final</title>
    <style>
        :root {
            --primary-bg: #f4f7f6;
            --secondary-bg: #ffffff;
            --header-bg: #4a5568;
            --accent-color: #4299e1;
            --text-color: #2d3748;
            --border-color: #e2e8f0;
            --danger-color: #e53e3e;
            --success-color: #48bb78;
            --sidebar-width: 220px;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body { font-family: var(--font-family); margin: 0; background-color: var(--primary-bg); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        #alarm-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; background-color: var(--danger-color); color: white; padding: 15px; text-align: center; z-index: 2000; font-size: 1.2em; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #alarm-banner button { background-color: white; color: var(--danger-color); border: 2px solid var(--danger-color); padding: 8px 20px; margin-left: 20px; font-weight: bold; }
        #alarm-banner button:hover { background-color: #fff5f5; }
        .sidebar { width: var(--sidebar-width); background-color: var(--header-bg); color: white; padding: 20px 0; display: flex; flex-direction: column; justify-content: space-between; flex-shrink: 0; transition: margin-left 0.3s ease; position: relative; }
        .sidebar.collapsed { margin-left: calc(-1 * var(--sidebar-width)); }
        .sidebar-nav a { display: block; color: white; padding: 15px 20px; text-decoration: none; font-size: 1.1em; border-left: 4px solid transparent; transition: background-color 0.3s, border-left 0.3s; white-space: nowrap; }
        .sidebar-nav a:hover, .sidebar-nav a.active { background-color: #2d3748; border-left: 4px solid var(--accent-color); }
        .settings-icon { padding: 15px 20px; cursor: pointer; text-align: center; border-top: 1px solid #718096; white-space: nowrap; }
        .settings-icon:hover { background-color: #2d3748; }
        .main-content { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        h1, h2 { color: var(--header-bg); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        button { background-color: var(--accent-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        button:disabled { background-color: #a0aec0; cursor: not-allowed; }
        button:disabled:hover { background-color: #a0aec0; }
        button:hover { background-color: #2b6cb0; }
        button.danger { background-color: var(--danger-color); }
        button.edit { background-color: #f6ad55; }
        button.duplicate { background-color: var(--success-color); }
        .action-buttons button { margin-left: 8px; padding: 5px 8px; font-size: 0.8em; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--secondary-bg); padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
        .subject-item, .topic-item { background-color: var(--secondary-bg); padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
        .item-info { display: flex; align-items: center; min-width: 0; }
        .color-preview { width: 20px; height: 20px; border-radius: 50%; margin-right: 15px; border: 1px solid #ccc; flex-shrink: 0; }
        .topic-container { margin-left: 40px; padding-left: 20px; border-left: 2px solid var(--border-color); }
        .description-text { font-size: 0.9em; color: #718096; margin-top: 5px; }
        #attachment-flow-step1, #attachment-flow-step2, #attachment-flow-step3, #directory-config { background-color: var(--secondary-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        #directory-status { padding: 10px; background-color: #e2e8f0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        #directory-status span { font-family: monospace; }
        #attachment-flow-step2, #attachment-flow-step3 { display: none; }
        .info-card { background-color: var(--primary-bg); border-left: 5px solid; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .attachment-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .attachment-item a { text-decoration: none; color: var(--accent-color); word-break: break-all; }
        .attachment-item a.file-not-found { color: var(--danger-color); text-decoration: line-through; pointer-events: none; }
        #flashcard-areas-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .flashcard-area-card { background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; cursor: pointer; transition: box-shadow 0.3s, transform 0.3s; display: flex; flex-direction: column; justify-content: space-between; min-height: 120px; }
        .flashcard-workspace { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(244, 247, 246, 0.9); backdrop-filter: blur(5px); z-index: 1500; display: none; flex-direction: column; }
        .workspace-header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .workspace-close-btn { font-size: 2em; font-weight: bold; cursor: pointer; color: var(--danger-color); }
        .workspace-canvas { position: relative; width: 100%; flex-grow: 1; overflow: auto; }
        .flashcard { position: absolute; width: 220px; height: 180px; background-color: #fffbe0; border: 1px solid #f6e05e; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border-radius: 5px; cursor: move; display: flex; flex-direction: column; padding: 5px; }
        .flashcard-header { display: flex; justify-content: flex-end; align-items: center; padding-bottom: 5px; }
        .flashcard-color-picker { width: 20px; height: 20px; border: 1px solid #ccc; cursor: pointer; margin-right: auto; border-radius: 3px; }
        .flashcard-actions button { background: none; border: none; color: #aaa; cursor: pointer; padding: 2px 5px; }
        .flashcard-textarea { width: 100%; height: 100%; border: none; background: transparent; resize: none; box-sizing: border-box; padding: 5px; font-family: inherit; }
        .schedules-container { display: grid; grid-template-columns: 1fr; gap: 25px; }
        @media (min-width: 992px) { .schedules-container { grid-template-columns: 1fr 1fr; } }
        .schedule-list, .review-list { background-color: var(--secondary-bg); padding: 20px; border-radius: 8px; }
        .schedule-item { padding: 15px; border: 1px solid var(--border-color); margin-bottom: 10px; border-radius: 4px; background-color: var(--primary-bg); }
        .schedule-item.completed { text-decoration: line-through; opacity: 0.7; background-color: #e2e8f0; }
        .schedule-info span { display: block; font-size: 0.9em; color: #718096; }
        .action-buttons { margin-top: 10px; }
        #sidebar-toggle { position: fixed; bottom: 15px; left: calc(var(--sidebar-width) - 45px); z-index: 101; width: 30px; height: 30px; background-color: rgba(0,0,0,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: left 0.3s ease, background-color 0.3s; }
        #sidebar-toggle:hover { background-color: rgba(0,0,0,0.5); }
        #sidebar-toggle svg { stroke: white; transition: transform 0.3s ease; }
        #sidebar-toggle.collapsed { left: 15px; }
        #sidebar-toggle.collapsed svg { transform: rotate(180deg); }
    </style>
</head>
<body>

    <div id="alarm-banner">
        <span>ALARME TOCANDO!</span>
        <button id="stop-alarm-btn">PARAR ALARME</button>
    </div>

    <aside class="sidebar" id="sidebar">
        <div>
            <nav class="sidebar-nav">
                <a href="#" class="tab-link active" data-tab="subjects">Matérias</a>
                <a href="#" class="tab-link" data-tab="attachments">Anexos</a>
                <a href="#" class="tab-link" data-tab="flashcards">Flashcards</a>
                <a href="#" class="tab-link" data-tab="schedules">Agendamentos</a>
            </nav>
        </div>
        <div class="settings-icon" id="settings-button">
            ⚙️ Configurações
        </div>
    </aside>

    <div id="sidebar-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
    </div>

    <main class="main-content" id="main-content">
        <div id="subjects-tab" class="tab-content active">
            <h1>Matérias e Assuntos</h1>
            <button id="add-subject-btn">Adicionar Matéria</button>
            <div id="subjects-list" class="mt-4"></div>
        </div>
        <div id="attachments-tab" class="tab-content">
            <h1>Anexos</h1>
            <div id="directory-config">
                <h2>Pasta de Anexos</h2>
                <p>Para anexar arquivos sem limite de tamanho, o programa precisa de permissão para acessar uma pasta no seu computador. Esta configuração é salva e só precisa ser feita uma vez.</p>
                <div id="directory-status"></div>
            </div>
            <div id="attachment-flow-step1">
                <h2>Passo 1: Selecione a Matéria</h2>
                <select id="attachment-subject-select" class="form-group"></select>
            </div>
            <div id="attachment-flow-step2">
                <h2>Passo 2: Selecione o Assunto</h2>
                <div id="attachment-subject-info" class="info-card"></div>
                <select id="attachment-topic-select" class="form-group"></select>
            </div>
            <div id="attachment-flow-step3">
                 <h2>Passo 3: Adicionar Anexos</h2>
                <div id="attachment-topic-info" class="info-card"></div>
                <button id="add-attachment-btn" disabled>Selecione uma Pasta de Anexos primeiro</button>
                <h3>Anexos Adicionados:</h3>
                <div id="attachments-list"></div>
            </div>
        </div>
        <div id="flashcards-tab" class="tab-content">
            <h1>Flashcards</h1>
            <button id="add-flashcard-area-btn">Adicionar Área de Flashcards</button>
            <div id="flashcard-areas-container" class="mt-4"></div>
        </div>
        <div id="schedules-tab" class="tab-content">
            <h1>Agendamentos e Revisões</h1>
            <button id="add-schedule-btn">Agendar Atividade</button>
            <button id="add-review-btn">Agendar Revisão</button>
            <div class="schedules-container mt-4">
                <div class="schedule-list">
                    <h2>Atividades Agendadas</h2>
                    <div id="scheduled-activities-list"></div>
                </div>
                <div class="review-list">
                    <h2>Revisões Agendadas</h2>
                    <div id="scheduled-reviews-list"></div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="subject-topic-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Adicionar Matéria</h2>
            <form id="subject-topic-form">
                <input type="hidden" id="edit-id"><input type="hidden" id="parent-id">
                <div class="form-group"><label for="name">Nome:</label><input type="text" id="name" name="name" required></div>
                <div class="form-group"><label for="description">Descrição:</label><textarea id="description" name="description" rows="3"></textarea></div>
                <div class="form-group"><label for="color">Cor:</label><input type="color" id="color" name="color" value="#4299e1"></div>
                <button type="submit">Salvar</button><button type="button" class="close-modal danger">Cancelar</button>
            </form>
        </div>
    </div>
    <div id="flashcard-area-modal" class="modal">
        <div class="modal-content">
            <h2 id="flashcard-area-modal-title">Nova Área de Flashcards</h2>
            <form id="flashcard-area-form">
                <input type="hidden" id="flashcard-area-edit-id">
                <div class="form-group"><label for="flashcard-area-name">Nome da Área:</label><input type="text" id="flashcard-area-name" required></div>
                <div class="form-group"><label for="flashcard-area-color">Cor de Destaque:</label><input type="color" id="flashcard-area-color" value="#f6e05e"></div>
                <button type="submit">Salvar</button><button type="button" class="close-modal danger">Cancelar</button>
            </form>
        </div>
    </div>
    <div id="flashcard-workspace" class="flashcard-workspace">
         <div class="workspace-header"><h2 id="workspace-title"></h2><div><button id="add-card-to-workspace-btn">Criar Cartão</button><span class="workspace-close-btn">&times;</span></div></div>
        <div id="workspace-canvas" class="workspace-canvas"></div>
    </div>
    <div id="schedule-modal" class="modal">
        <div class="modal-content">
            <h2 id="schedule-modal-title">Agendar Atividade</h2>
            <form id="schedule-form">
                <input type="hidden" id="schedule-edit-id"><input type="hidden" id="schedule-type">
                <div class="form-group"><label for="schedule-subject">Matéria:</label><select id="schedule-subject" required></select></div>
                <div class="form-group"><label for="schedule-topic">Assunto:</label><select id="schedule-topic" required></select></div>
                <div class="form-group"><label for="start-time">Data e Hora de Início:</label><input type="datetime-local" id="start-time" required></div>
                <div class="form-group"><label for="end-time">Data e Hora de Fim:</label><input type="datetime-local" id="end-time" required></div>
                <button type="submit">Salvar Agendamento</button><button type="button" class="close-modal danger">Cancelar</button>
            </form>
        </div>
    </div>
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2>Configurações</h2>
            <p>Faça a gestão dos seus dados. É recomendado exportar seus dados regularmente como backup.</p>
            <button id="export-data-btn">Exportar Dados</button>
            <div class="form-group" style="margin-top: 20px;"><label for="import-file-input">Importar Dados (substitui os dados atuais):</label><input type="file" id="import-file-input" accept=".json"></div>
            <hr>
            <p style="font-size:0.8em; color: #718096;"><strong>Exportação Automática:</strong> Não é possível por restrições de segurança dos navegadores.</p>
            <button type="button" class="close-modal danger" style="margin-top: 15px;">Fechar</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    let data = {
        subjects: [],
        flashcardAreas: [],
        schedules: { activities: [], reviews: [] },
        nextIds: { subject: 1, topic: 1, attachment: 1, flashcardArea: 1, flashcard: 1, schedule: 1 }
    };
    
    let rootDirectoryHandle = null;
    let db;
    let alarmInterval = null;
    let audioContext;
    let activeAlarmSound = null;

    function initAudioContext() {
        if (!audioContext && (window.AudioContext || window.webkitAudioContext)) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch(e) { console.error("Web Audio API não é suportada.", e); }
        }
    }
    function playDefaultBeep() {
        if (!audioContext) return null;
        if (audioContext.state === 'suspended') audioContext.resume();
        const gainNode = audioContext.createGain();
        gainNode.connect(audioContext.destination);
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
        oscillator.connect(gainNode);
        oscillator.start();
        const interval = setInterval(() => {
            gainNode.gain.cancelScheduledValues(audioContext.currentTime);
            gainNode.gain.setValueAtTime(gainNode.gain.value, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.1);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
        }, 600);
        return { oscillator, gainNode, interval };
    }
    function stopDefaultBeep(beep) {
        if (!beep) return;
        clearInterval(beep.interval);
        beep.oscillator.stop();
        beep.oscillator.disconnect();
        beep.gainNode.disconnect();
    }

    const modals = document.querySelectorAll('.modal');
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');
    
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('StudyAppDB_v2', 1);
            request.onerror = () => reject("Erro ao abrir IndexedDB.");
            request.onsuccess = (event) => { db = event.target.result; resolve(); };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'id' });
            };
        });
    }
    function saveDirectoryHandle(handle) {
        if (!db) return Promise.reject("DB não inicializado.");
        const transaction = db.transaction(['settings'], 'readwrite');
        return transaction.objectStore('settings').put({ id: 'rootDirectory', handle });
    }
    function loadDirectoryHandle() {
        if (!db) return Promise.resolve(null);
        const request = db.transaction(['settings'], 'readonly').objectStore('settings').get('rootDirectory');
        return new Promise((resolve) => {
            request.onsuccess = () => resolve(request.result ? request.result.handle : null);
            request.onerror = () => resolve(null);
        });
    }
    async function initializeApp() {
        try {
            await initDB();
            rootDirectoryHandle = await loadDirectoryHandle();
            updateDirectoryStatus();
            loadData();
            renderAll();
            startAlarmSystem();
            setupSidebarToggle();
        } catch (error) { console.error("Falha na inicialização:", error); }
    }
    function saveData() { try { localStorage.setItem('studyOrganizerData_v2', JSON.stringify(data)); } catch (e) { console.error("Erro ao salvar dados:", e); } }
    function loadData() { const savedData = localStorage.getItem('studyOrganizerData_v2'); if (savedData) data = JSON.parse(savedData); }
    function renderAll() { renderSubjects(); renderFlashcardAreas(); updateAttachmentSelectors(); renderSchedules(); }
    
    tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = e.target.getAttribute('data-tab');
            tabLinks.forEach(l => l.classList.remove('active'));
            e.target.classList.add('active');
            tabContents.forEach(content => {
                const isActive = content.id === `${tabId}-tab`;
                content.classList.toggle('active', isActive);
                content.style.display = isActive ? 'block' : 'none';
            });
            if (tabId === 'schedules') initAudioContext();
            if (tabId === 'attachments') updateAttachmentSelectors();
        });
    });
    function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
    function closeModal() { modals.forEach(modal => modal.style.display = 'none'); }
    document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', closeModal));
    window.addEventListener('click', (e) => { modals.forEach(modal => { if (e.target === modal) closeModal(); }); });
    function getNextId(type) { if (!data.nextIds[type]) data.nextIds[type] = 1; const id = data.nextIds[type]; data.nextIds[type]++; return id; }
    
    const directoryStatusDiv = document.getElementById('directory-status');
    const addAttachmentBtn = document.getElementById('add-attachment-btn');
    const attachmentSubjectSelect = document.getElementById('attachment-subject-select');
    const attachmentTopicSelect = document.getElementById('attachment-topic-select');
    const attachmentsListDiv = document.getElementById('attachments-list');
    const attachmentStep2 = document.getElementById('attachment-flow-step2');
    const attachmentStep3 = document.getElementById('attachment-flow-step3');

    function updateDirectoryStatus() {
        if (rootDirectoryHandle) {
            directoryStatusDiv.innerHTML = `<span>Pasta: <b>${rootDirectoryHandle.name}</b></span><button id="change-dir-btn">Trocar</button>`;
            addAttachmentBtn.disabled = false;
            addAttachmentBtn.textContent = 'Adicionar Anexo';
            document.getElementById('change-dir-btn').addEventListener('click', requestDirectoryPermission);
        } else {
            directoryStatusDiv.innerHTML = `<span>Nenhuma pasta configurada.</span><button id="select-dir-btn">Selecionar Pasta</button>`;
            addAttachmentBtn.disabled = true;
            addAttachmentBtn.textContent = 'Configure uma pasta primeiro';
            document.getElementById('select-dir-btn').addEventListener('click', requestDirectoryPermission);
        }
    }
    async function requestDirectoryPermission() {
        try {
            const handle = await window.showDirectoryPicker();
            if ((await handle.queryPermission({ mode: 'readwrite' })) !== 'granted') {
                if ((await handle.requestPermission({ mode: 'readwrite' })) !== 'granted') {
                    alert("Permissão negada."); return;
                }
            }
            rootDirectoryHandle = handle;
            await saveDirectoryHandle(handle);
            updateDirectoryStatus();
        } catch (err) { console.error("Seleção de pasta cancelada:", err); }
    }
    function updateAttachmentSelectors() {
        attachmentSubjectSelect.innerHTML = '<option value="">Selecione uma matéria...</option>';
        data.subjects.forEach(s => { attachmentSubjectSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`; });
        attachmentStep2.style.display = 'none';
        attachmentStep3.style.display = 'none';
    }
    attachmentSubjectSelect.addEventListener('change', () => {
        const subjectId = attachmentSubjectSelect.value;
        attachmentTopicSelect.innerHTML = '<option value="">Selecione um assunto...</option>';
        attachmentStep3.style.display = 'none';
        if(subjectId) {
            const subject = data.subjects.find(s => s.id == subjectId);
            document.getElementById('attachment-subject-info').innerHTML = `<h3>${subject.name}</h3><p>${subject.description||'Sem descrição'}</p>`;
            subject.topics.forEach(t => { attachmentTopicSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`; });
            attachmentStep2.style.display = 'block';
        } else {
            attachmentStep2.style.display = 'none';
        }
    });
    attachmentTopicSelect.addEventListener('change', async () => {
        const topicId = attachmentTopicSelect.value;
        if(topicId) {
            const subjectId = attachmentSubjectSelect.value;
            const subject = data.subjects.find(s => s.id == subjectId);
            const topic = subject.topics.find(t => t.id == topicId);
            document.getElementById('attachment-topic-info').innerHTML = `<h3>${topic.name}</h3><p>${topic.description||'Sem descrição'}</p>`;
            attachmentStep3.style.display = 'block';
            await renderAttachments(subjectId, topicId);
        } else {
            attachmentStep3.style.display = 'none';
        }
    });
    addAttachmentBtn.addEventListener('click', async () => {
        const subjectId = attachmentSubjectSelect.value, topicId = attachmentTopicSelect.value;
        if (!subjectId || !topicId) { alert("Selecione matéria e assunto."); return; }
        try {
            const [fileHandle] = await window.showOpenFilePicker();
            const subject = data.subjects.find(s => s.id == subjectId);
            const topic = subject.topics.find(t => t.id == topicId);
            if(!topic.attachments) topic.attachments = [];
            try { await rootDirectoryHandle.getFileHandle(fileHandle.name); }
            catch(e) {
                 const file = await fileHandle.getFile();
                 const newFile = await rootDirectoryHandle.getFileHandle(file.name, { create: true });
                 const writable = await newFile.createWritable();
                 await writable.write(file);
                 await writable.close();
            }
            topic.attachments.push({ id: getNextId('attachment'), type: 'filesystem', name: fileHandle.name });
            saveData();
            await renderAttachments(subjectId, topicId);
        } catch (err) { console.log("Seleção de arquivo cancelada.", err); }
    });
    async function renderAttachments(subjectId, topicId) {
        attachmentsListDiv.innerHTML = 'Carregando...';
        const subject = data.subjects.find(s => s.id == subjectId);
        const topic = subject.topics.find(t => t.id == topicId);
        if (!topic.attachments || topic.attachments.length === 0) {
            attachmentsListDiv.innerHTML = '<p>Nenhum anexo.</p>'; return;
        }
        const htmlPromises = topic.attachments.map(async (att) => {
            if (att.type === 'filesystem' && rootDirectoryHandle) {
                try {
                    const file = await (await rootDirectoryHandle.getFileHandle(att.name)).getFile();
                    const url = URL.createObjectURL(file);
                    return `<div class="attachment-item"><a href="${url}" target="_blank" rel="noopener noreferrer">${att.name}</a><button class="delete-btn danger" data-id="${att.id}">Excluir</button></div>`;
                } catch (error) {
                    return `<div class="attachment-item"><a class="file-not-found">${att.name} (Não encontrado)</a><button class="delete-btn danger" data-id="${att.id}">Excluir</button></div>`;
                }
            }
            return '';
        });
        attachmentsListDiv.innerHTML = (await Promise.all(htmlPromises)).join('');
        attachmentsListDiv.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (confirm('Excluir referência?')) {
                    const topic = data.subjects.find(s => s.id == subjectId).topics.find(t => t.id == topicId);
                    topic.attachments = topic.attachments.filter(a => a.id != btn.dataset.id);
                    saveData();
                    await renderAttachments(subjectId, topicId);
                }
            });
        });
    }

    const subjectTopicForm = document.getElementById('subject-topic-form');
    const subjectsListDiv = document.getElementById('subjects-list');
    function renderSubjects() {
        subjectsListDiv.innerHTML = '';
        data.subjects.forEach(subject => {
            const subjectEl = document.createElement('div');
            subjectEl.className = 'subject-item';
            subjectEl.innerHTML = `<div class="item-info"><div class="color-preview" style="background-color:${subject.color};"></div><div><strong>${subject.name}</strong>${subject.description?`<p class="description-text">${subject.description}</p>`:''}</div></div><div class="action-buttons"><button class="add-topic-btn" data-id="${subject.id}">+ Assunto</button><button class="edit-btn edit" data-type="subject" data-id="${subject.id}">Editar</button><button class="duplicate-btn duplicate" data-type="subject" data-id="${subject.id}">Duplicar</button><button class="delete-btn danger" data-type="subject" data-id="${subject.id}">Excluir</button></div>`;
            const topicContainer = document.createElement('div');
            topicContainer.className = 'topic-container';
            subject.topics.forEach(topic => {
                const topicEl = document.createElement('div');
                topicEl.className = 'topic-item';
                topicEl.innerHTML = `<div class="item-info"><div class="color-preview" style="background-color:${topic.color};"></div><div><strong>${topic.name}</strong>${topic.description?`<p class="description-text">${topic.description}</p>`:''}</div></div><div class="action-buttons"><button class="edit-btn edit" data-type="topic" data-id="${topic.id}" data-parent-id="${subject.id}">Editar</button><button class="duplicate-btn duplicate" data-type="topic" data-id="${topic.id}" data-parent-id="${subject.id}">Duplicar</button><button class="delete-btn danger" data-type="topic" data-id="${topic.id}" data-parent-id="${subject.id}">Excluir</button></div>`;
                topicContainer.appendChild(topicEl);
            });
            subjectsListDiv.appendChild(subjectEl);
            subjectsListDiv.appendChild(topicContainer);
        });
    }
    document.getElementById('add-subject-btn').addEventListener('click', () => { subjectTopicForm.reset(); document.getElementById('modal-title').innerText = 'Adicionar Matéria'; document.getElementById('edit-id').value = ''; document.getElementById('parent-id').value = ''; openModal('subject-topic-modal'); });
    subjectTopicForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const { name, description, color } = Object.fromEntries(new FormData(e.target).entries());
        const editId = document.getElementById('edit-id').value, parentId = document.getElementById('parent-id').value;
        if (parentId) {
            const p = data.subjects.find(s => s.id == parentId);
            if (editId) Object.assign(p.topics.find(t => t.id == editId), {name, description, color});
            else p.topics.push({ id: getNextId('topic'), name, description, color, attachments: [] });
        } else {
            if (editId) Object.assign(data.subjects.find(s => s.id == editId), {name, description, color});
            else data.subjects.push({ id: getNextId('subject'), name, description, color, topics: [] });
        }
        renderAll(); saveData(); closeModal();
    });
    subjectsListDiv.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const { id, type, parentId } = target.dataset;
        if (target.classList.contains('add-topic-btn')) { subjectTopicForm.reset(); document.getElementById('modal-title').innerText = 'Adicionar Assunto'; document.getElementById('edit-id').value = ''; document.getElementById('parent-id').value = id; openModal('subject-topic-modal'); }
        else if (target.classList.contains('edit-btn')) {
            const item = type === 'subject' ? data.subjects.find(s => s.id == id) : data.subjects.find(s => s.id == parentId).topics.find(t => t.id == id);
            document.getElementById('modal-title').innerText = `Editar ${type==='subject'?'Matéria':'Assunto'}`;
            document.getElementById('edit-id').value = id;
            document.getElementById('parent-id').value = parentId || '';
            document.getElementById('name').value = item.name;
            document.getElementById('description').value = item.description;
            document.getElementById('color').value = item.color;
            openModal('subject-topic-modal');
        } else if (target.classList.contains('delete-btn')) {
            if (confirm('Excluir?')) {
                if (type === 'subject') data.subjects = data.subjects.filter(s => s.id != id);
                else data.subjects.find(s => s.id == parentId).topics = data.subjects.find(s => s.id == parentId).topics.filter(t => t.id != id);
                renderAll(); saveData();
            }
        } else if (target.classList.contains('duplicate-btn')) {
             if (type === 'subject') {
                const newSubject = JSON.parse(JSON.stringify(data.subjects.find(s => s.id == id)));
                newSubject.id = getNextId('subject'); newSubject.name += ' (Cópia)';
                newSubject.topics.forEach(t => { t.id = getNextId('topic'); if(t.attachments) t.attachments.forEach(a => a.id = getNextId('attachment')) });
                data.subjects.push(newSubject);
            } else {
                const parent = data.subjects.find(s => s.id == parentId);
                const newTopic = JSON.parse(JSON.stringify(parent.topics.find(t => t.id == id)));
                newTopic.id = getNextId('topic'); newTopic.name += ' (Cópia)';
                if(newTopic.attachments) newTopic.attachments.forEach(a => a.id = getNextId('attachment'));
                parent.topics.push(newTopic);
            }
            renderAll(); saveData();
        }
    });

    const flashcardAreasContainer = document.getElementById('flashcard-areas-container');
    const areaForm = document.getElementById('flashcard-area-form');
    const workspace = document.getElementById('flashcard-workspace');
    const workspaceCanvas = document.getElementById('workspace-canvas');
    function renderFlashcardAreas() {
        flashcardAreasContainer.innerHTML = '';
        data.flashcardAreas.forEach(area => {
            const areaEl = document.createElement('div');
            areaEl.className = 'flashcard-area-card';
            areaEl.dataset.id = area.id;
            areaEl.style.borderTop = `5px solid ${area.color}`;
            areaEl.innerHTML = `<div><h3>${area.name}</h3></div><div class="action-buttons"><button class="edit-btn edit">Editar</button><button class="duplicate-btn duplicate">Duplicar</button><button class="delete-btn danger">Excluir</button></div>`;
            areaEl.addEventListener('click', (e) => { if (!e.target.closest('button')) openWorkspace(area.id); });
            flashcardAreasContainer.appendChild(areaEl);
        });
    }
    document.getElementById('add-flashcard-area-btn').addEventListener('click', () => { areaForm.reset(); document.getElementById('flashcard-area-modal-title').innerText = 'Nova Área'; document.getElementById('flashcard-area-edit-id').value = ''; openModal('flashcard-area-modal'); });
    areaForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('flashcard-area-name').value, color = document.getElementById('flashcard-area-color').value;
        const editId = document.getElementById('flashcard-area-edit-id').value;
        if (editId) Object.assign(data.flashcardAreas.find(a => a.id == editId), {name, color});
        else data.flashcardAreas.push({ id: getNextId('flashcardArea'), name, color, cards: [] });
        renderFlashcardAreas(); saveData(); closeModal();
    });
    flashcardAreasContainer.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        const id = e.target.closest('.flashcard-area-card').dataset.id;
        if (button.classList.contains('edit-btn')) {
            const area = data.flashcardAreas.find(a => a.id == id);
            document.getElementById('flashcard-area-modal-title').innerText = 'Editar Área';
            document.getElementById('flashcard-area-edit-id').value = id;
            document.getElementById('flashcard-area-name').value = area.name;
            document.getElementById('flashcard-area-color').value = area.color;
            openModal('flashcard-area-modal');
        } else if (button.classList.contains('delete-btn')) {
            if (confirm('Excluir área e flashcards?')) { data.flashcardAreas = data.flashcardAreas.filter(a => a.id != id); renderFlashcardAreas(); saveData(); }
        } else if (button.classList.contains('duplicate-btn')) {
            const newArea = JSON.parse(JSON.stringify(data.flashcardAreas.find(a => a.id == id)));
            newArea.id = getNextId('flashcardArea'); newArea.name += ' (Cópia)';
            newArea.cards.forEach(c => c.id = getNextId('flashcard'));
            data.flashcardAreas.push(newArea);
            renderFlashcardAreas(); saveData();
        }
    });
    function openWorkspace(areaId) {
        workspace.dataset.areaId = areaId;
        document.getElementById('workspace-title').innerText = data.flashcardAreas.find(a => a.id == areaId).name;
        renderCardsInWorkspace(areaId);
        workspace.style.display = 'flex';
    }
    document.querySelector('.workspace-close-btn').addEventListener('click', () => { workspace.style.display = 'none'; });
    document.getElementById('add-card-to-workspace-btn').addEventListener('click', () => {
        const area = data.flashcardAreas.find(a => a.id == workspace.dataset.areaId);
        area.cards.push({ id: getNextId('flashcard'), content: '', color: '#fffbe0', x: 20, y: 20 });
        renderCardsInWorkspace(area.id); saveData();
    });
    function renderCardsInWorkspace(areaId) {
        workspaceCanvas.innerHTML = '';
        data.flashcardAreas.find(a => a.id == areaId).cards.forEach(card => workspaceCanvas.appendChild(createFlashcardElement(card, areaId)));
    }
    function createFlashcardElement(card, areaId) {
        const cardEl = document.createElement('div'); cardEl.className = 'flashcard';
        Object.assign(cardEl.style, {left: card.x+'px', top: card.y+'px', backgroundColor: card.color});
        cardEl.dataset.id = card.id;
        cardEl.innerHTML = `<div class="flashcard-header"><input type="color" class="flashcard-color-picker" value="${card.color}"><div class="flashcard-actions"><button class="duplicate-card">❏</button><button class="delete-card">×</button></div></div><textarea class="flashcard-textarea">${card.content}</textarea>`;
        let isDragging=false,offsetX,offsetY;
        cardEl.addEventListener('mousedown',(e)=>{if(e.target.matches('textarea,input,button'))return;isDragging=true;offsetX=e.clientX-cardEl.offsetLeft;offsetY=e.clientY-cardEl.offsetTop;cardEl.style.zIndex=10;});
        document.addEventListener('mousemove',(e)=>{if(isDragging){cardEl.style.left=(e.clientX-offsetX)+'px';cardEl.style.top=(e.clientY-offsetY)+'px';}});
        document.addEventListener('mouseup',()=>{if(isDragging){const c=data.flashcardAreas.find(a=>a.id==areaId).cards.find(c=>c.id==card.id);c.x=cardEl.offsetLeft;c.y=cardEl.offsetTop;isDragging=false;cardEl.style.zIndex=1;saveData();}});
        cardEl.querySelector('.flashcard-textarea').addEventListener('input',(e)=>{data.flashcardAreas.find(a=>a.id==areaId).cards.find(c=>c.id==card.id).content=e.target.value;saveData();});
        cardEl.querySelector('.flashcard-color-picker').addEventListener('input',(e)=>{data.flashcardAreas.find(a=>a.id==areaId).cards.find(c=>c.id==card.id).color=e.target.value;cardEl.style.backgroundColor=e.target.value;saveData();});
        cardEl.querySelector('.delete-card').addEventListener('click',()=>{const a=data.flashcardAreas.find(a=>a.id==areaId);a.cards=a.cards.filter(c=>c.id!=card.id);renderCardsInWorkspace(areaId);saveData();});
        cardEl.querySelector('.duplicate-card').addEventListener('click',()=>{const a=data.flashcardAreas.find(a=>a.id==areaId);const o=a.cards.find(c=>c.id==card.id);const n=JSON.parse(JSON.stringify(o));n.id=getNextId('flashcard');n.x+=20;n.y+=20;a.cards.push(n);renderCardsInWorkspace(areaId);saveData();});
        return cardEl;
    }

    const scheduleForm = document.getElementById('schedule-form');
    function renderSchedules() {
        const now = new Date();
        const activitiesList = document.getElementById('scheduled-activities-list');
        const reviewsList = document.getElementById('scheduled-reviews-list');
        activitiesList.innerHTML = ''; reviewsList.innerHTML = '';
        data.schedules.activities.sort((a,b)=>new Date(a.startTime)-new Date(b.startTime)).forEach(item=>activitiesList.appendChild(createScheduleElement(item,now)));
        data.schedules.reviews.sort((a,b)=>new Date(a.startTime)-new Date(b.startTime)).forEach(item=>reviewsList.appendChild(createScheduleElement(item,now)));
    }
    function createScheduleElement(item, now) {
        const el = document.createElement('div'); el.className = 'schedule-item';
        if (now > new Date(item.endTime)) el.classList.add('completed');
        const subject = data.subjects.find(s => s.id == item.subjectId);
        const topic = subject?.topics.find(t => t.id == item.topicId);
        el.innerHTML = `<strong>${subject?.name||'Excluído'} > ${topic?.name||'Excluído'}</strong><div class="schedule-info"><span>Início: ${new Date(item.startTime).toLocaleString('pt-BR')}</span><span>Fim: ${new Date(item.endTime).toLocaleString('pt-BR')}</span></div><div class="action-buttons"><button class="edit-btn edit">Editar</button><button class="delete-btn danger">Excluir</button></div>`;
        el.querySelector('.edit-btn').addEventListener('click', () => openScheduleModal(item.type, item.id));
        el.querySelector('.delete-btn').addEventListener('click', () => { if (confirm('Excluir?')) { const k=item.type==='activity'?'activities':'reviews'; data.schedules[k]=data.schedules[k].filter(i=>i.id!=item.id); renderSchedules(); saveData(); }});
        return el;
    }
    function openScheduleModal(type, id = null) {
        scheduleForm.reset();
        document.getElementById('schedule-type').value = type;
        const subjectSelect = document.getElementById('schedule-subject');
        subjectSelect.innerHTML = '<option value="">Selecione</option>' + data.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        const topicSelect = document.getElementById('schedule-topic');
        subjectSelect.onchange = () => {
            topicSelect.innerHTML = '<option value="">Selecione</option>';
            const selSubject = data.subjects.find(s => s.id == subjectSelect.value);
            if (selSubject) topicSelect.innerHTML += selSubject.topics.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        };
        if(id) {
            const item = data.schedules[type === 'activity' ? 'activities' : 'reviews'].find(i => i.id == id);
            document.getElementById('schedule-modal-title').innerText = `Editar ${type==='activity'?'Atividade':'Revisão'}`;
            document.getElementById('schedule-edit-id').value = id;
            subjectSelect.value = item.subjectId;
            subjectSelect.dispatchEvent(new Event('change'));
            topicSelect.value = item.topicId;
            document.getElementById('start-time').value = item.startTime;
            document.getElementById('end-time').value = item.endTime;
        } else {
            document.getElementById('schedule-modal-title').innerText = `Agendar ${type==='activity'?'Atividade':'Revisão'}`;
            document.getElementById('schedule-edit-id').value = '';
            topicSelect.innerHTML = '<option value="">Selecione a matéria</option>';
        }
        openModal('schedule-modal');
    }
    document.getElementById('add-schedule-btn').addEventListener('click', () => openScheduleModal('activity'));
    document.getElementById('add-review-btn').addEventListener('click', () => openScheduleModal('review'));
    scheduleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const editId = document.getElementById('schedule-edit-id').value;
        const newStart = new Date(document.getElementById('start-time').value);
        const newEnd = new Date(document.getElementById('end-time').value);
        if (newEnd <= newStart) { alert("O horário final deve ser depois do horário de início."); return; }
        const hasConflict = [...data.schedules.activities, ...data.schedules.reviews].some(event => {
            if (editId && event.id == editId) return false;
            const oldStart = new Date(event.startTime);
            const oldEnd = new Date(event.endTime);
            return (newStart < oldEnd) && (newEnd > oldStart);
        });
        if (hasConflict) { alert("Conflito de horário! Você já tem outra tarefa agendada neste período."); return; }
        const scheduleData = { subjectId:document.getElementById('schedule-subject').value, topicId:document.getElementById('schedule-topic').value, startTime:document.getElementById('start-time').value, endTime:document.getElementById('end-time').value, type:document.getElementById('schedule-type').value };
        const listKey = scheduleData.type === 'activity' ? 'activities' : 'reviews';
        if (editId) {
            const index = data.schedules[listKey].findIndex(i => i.id == editId);
            data.schedules[listKey][index] = { ...data.schedules[listKey][index], ...scheduleData, notified: false };
        } else {
            data.schedules[listKey].push({ id: getNextId('schedule'), ...scheduleData, notified: false });
        }
        renderSchedules(); saveData(); closeModal();
    });
    function stopAlarmSound() { stopDefaultBeep(activeAlarmSound); activeAlarmSound = null; document.getElementById('alarm-banner').style.display = 'none'; }
    function startAlarmSystem() {
        if (alarmInterval) clearInterval(alarmInterval);
        document.getElementById('stop-alarm-btn').addEventListener('click', stopAlarmSound);
        alarmInterval = setInterval(() => {
            const now = new Date();
            [...data.schedules.activities, ...data.schedules.reviews].forEach(item => {
                const startTime = new Date(item.startTime);
                if (now >= startTime && !item.notified) {
                    if (!activeAlarmSound) {
                        initAudioContext();
                        activeAlarmSound = playDefaultBeep();
                        if(activeAlarmSound) document.getElementById('alarm-banner').style.display = 'block';
                        if (Notification.permission === "granted") {
                            const subject = data.subjects.find(s => s.id == item.subjectId);
                            const topic = subject?.topics.find(t => t.id == item.topicId);
                            const notification = new Notification("Hora de Estudar!", { body: `Sua tarefa de "${subject?.name||''}" > "${topic?.name||''}" começou.` });
                            notification.onclose = stopAlarmSound;
                        } else if (Notification.permission === 'default') Notification.requestPermission();
                    }
                    item.notified = true;
                    saveData();
                }
            });
            renderSchedules();
        }, 5000);
    }

    document.getElementById('settings-button').addEventListener('click', () => openModal('settings-modal'));
    document.getElementById('export-data-btn').addEventListener('click', () => { const dataStr = JSON.stringify(data); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `backup_estudos_${new Date().toISOString().slice(0, 10)}.json`; link.click(); URL.revokeObjectURL(url); });
    document.getElementById('import-file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file || !confirm("ATENÇÃO: Importar substituirá TODOS os dados atuais. Continuar?")) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (importedData?.subjects && importedData?.nextIds) {
                    data = importedData; saveData(); alert("Dados importados! A página será recarregada."); location.reload();
                } else { alert("Erro: Arquivo de backup inválido."); }
            } catch (err) { alert("Erro ao processar o arquivo."); }
        };
        reader.readAsText(file); e.target.value = '';
    });
    
    function setupSidebarToggle() {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('sidebar-toggle');
        
        const applyState = (isCollapsed) => {
            sidebar.classList.toggle('collapsed', isCollapsed);
            toggleBtn.classList.toggle('collapsed', isCollapsed);
        };
        
        toggleBtn.addEventListener('click', () => {
            const isCollapsed = sidebar.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed', isCollapsed);
            localStorage.setItem('sidebarCollapsed_v2', isCollapsed);
        });

        const savedState = localStorage.getItem('sidebarCollapsed_v2') === 'true';
        applyState(savedState);
    }

    if ('showDirectoryPicker' in window) {
        initializeApp();
    } else {
        alert("Seu navegador não suporta a File System Access API. Use Chrome ou Edge.");
        document.querySelector('[data-tab="attachments"]').style.display = 'none';
    }
});
</script>
</body>
</html>